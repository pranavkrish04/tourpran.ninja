I"ñ<h3 id="intro">Intro:</h3>
<p>Played InCTFj Quals this winter vacation. It was a fun filled ctf. Here we will discuss the pwn challenge called <code class="language-plaintext highlighter-rouge">leaky pipes</code>. Make sure to give the challenge a try before seeing this.</p>

<h3 id="challenge-file">Challenge file:</h3>
<p><a href="/assets/leakyinctfj/leaky_pipes">vuln binary</a> and 
<a href="/assets/leakyinctfj/leaky.c">vuln c code</a></p>

<h3 id="pre-requisites">Pre requisites:</h3>
<ul>
  <li>Basic understanding of how computers work.</li>
  <li>Know what format strings are.</li>
  <li>will to learn more from googling.</li>
</ul>

<h3 id="mitigations">Mitigations:</h3>

<p><img src="/assets/leakyinctfj/ss1.png" alt="" /></p>

<ul>
  <li>Most of the format string exploitation will have all the mitigations enabled.</li>
  <li>RELRO: GOT related stuff.</li>
  <li>Stack Canary: unique value stoping buffer overflow.</li>
  <li>NX: Makes the stack not excecutable.</li>
  <li>PIE: the binary will have different address during different runs.</li>
</ul>

<h3 id="sample-run">Sample run:</h3>
<p>Lets simply run the binary, while doing this make sure to read the c code and get comfortable with the binary as a whole.</p>

<p><img src="/assets/leakyinctfj/ss2.png" alt="" /></p>

<ul>
  <li>We can give three options (1, 2, 3) but 2 options doesnt do anything.</li>
  <li>option 1: Give an input and get same output back from the printf function.</li>
  <li>option 3: Currently unavailable since we dont have enough cash.</li>
</ul>

<h3 id="exploit-basics">Exploit Basics:</h3>
<p>Format string exploitation occurs when you use the printf function carelessly. Correct Usage of printf will be to use the format strings/ format specifiers in the first part and all the parameters in the 2nd part.</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">printf</span><span class="p">(</span><span class="s">"my name is : %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"giovanni giorgio"</span><span class="p">);</span>
</code></pre></div></div>
<p>Problem occurs when attackers are given access to these format strings part. So as an attacker he can specify formats which will try to retrieve values that are not specified, hence will take values from the stack. Incorrect usage.</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">printf</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span> <span class="c1">//buffer = user input</span>
</code></pre></div></div>

<h3 id="exploit-idea">Exploit Idea:</h3>
<p>We have to somehow go to the use_tape() Since it has our flag and another format string exploit.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">use_tape</span><span class="p">(){</span>
	<span class="kt">char</span> <span class="n">experience</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">flag</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>

	<span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">"flag.txt"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">fp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
		<span class="n">fgets</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

		<span class="n">printf</span><span class="p">(</span><span class="s">"Please give us your feedback!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">fgets</span><span class="p">(</span><span class="n">experience</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="n">experience</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span><span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"Error opening file!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>But the small caviat is we canâ€™t go there directly we somehow have to increase our balance from 100 to 200 (exactly) and then call <code class="language-plaintext highlighter-rouge">buy_repair_kit()</code>.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">buy_repair_kit</span><span class="p">(){</span>
    <span class="k">if</span><span class="p">(</span><span class="n">bal</span> <span class="o">==</span> <span class="mi">200</span><span class="p">){</span>
        <span class="n">use_tape</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"You do not have enough balance! :(</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="format-string-1">Format string 1:</h3>

<p>First I leak the entire stack(useful range) with the help of %p (gives the hexadecimal value of what is in the stack).</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"-%p"</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="n">leak</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">leak</span> <span class="o">=</span> <span class="n">leak</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s">"-"</span><span class="p">)</span>
</code></pre></div></div>
<p>Sending many %p with the â€˜-â€˜ acting as a delimiter between all the values leaked from the stack. (easy to split and put them in a list)</p>
:ET